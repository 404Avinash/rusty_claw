<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>CLAW — AI Legal Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0e1a;--bg1:#0f1424;--bg2:#151b2e;--bg3:#1c2440;--bg4:#232d4a;
  --surface:rgba(255,255,255,.03);
  --border:rgba(99,179,237,.08);--border2:rgba(99,179,237,.15);
  --accent:#6ea8fe;--accent2:#8b5cf6;--accent-g:linear-gradient(135deg,#6ea8fe,#8b5cf6);
  --green:#34d399;--green-d:rgba(52,211,153,.1);--green-b:rgba(52,211,153,.2);
  --red:#f87171;--red-d:rgba(248,113,113,.08);--red-b:rgba(248,113,113,.2);
  --gold:#fbbf24;--gold-d:rgba(251,191,36,.08);
  --t0:#fff;--t1:#e2e8f0;--t2:#94a3b8;--t3:#64748b;--t4:#475569;
  --font:'Inter',system-ui,sans-serif;--mono:'JetBrains Mono',monospace;
  --r:12px;--rs:8px;--rl:16px;
  --shadow:0 4px 24px rgba(0,0,0,.25);
  --shadow-lg:0 8px 40px rgba(0,0,0,.35);
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--t1);font-family:var(--font);font-size:14px}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
::-webkit-scrollbar-track{background:transparent}

/* ═══ AMBIENT ════════════════════════════════ */
body::before{content:"";position:fixed;inset:0;
  background:radial-gradient(ellipse 60% 50% at 15% 5%,rgba(110,168,254,.04),transparent),
             radial-gradient(ellipse 50% 40% at 85% 90%,rgba(139,92,246,.04),transparent);
  pointer-events:none;z-index:0}

/* ═══ HEADER ═════════════════════════════════ */
.hdr{position:relative;z-index:20;background:rgba(15,20,36,.85);backdrop-filter:blur(24px);
  border-bottom:1px solid var(--border);height:52px;padding:0 24px;
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.hdr-left{display:flex;align-items:center;gap:12px}
.hdr-logo{width:32px;height:32px;border-radius:8px;background:var(--accent-g);
  display:flex;align-items:center;justify-content:center;font-size:16px;
  box-shadow:0 0 20px rgba(110,168,254,.2)}
.hdr-name{font-size:16px;font-weight:800;letter-spacing:-.02em;
  background:var(--accent-g);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hdr-sub{font-size:10px;color:var(--t3);letter-spacing:.02em}
.hdr-right{display:flex;align-items:center;gap:12px}
.hdr-stat{display:flex;flex-direction:column;align-items:center;min-width:36px}
.hdr-stat-n{font-size:15px;font-weight:800;line-height:1}
.hdr-stat-l{font-size:8px;text-transform:uppercase;letter-spacing:.06em;color:var(--t3)}
.h-green .hdr-stat-n{color:var(--green)}.h-red .hdr-stat-n{color:var(--red)}.h-blue .hdr-stat-n{color:var(--accent)}
.hdr-pill{font-size:9px;font-weight:700;padding:3px 10px;border-radius:20px;letter-spacing:.04em;border:1px solid}
.pill-bns{color:var(--green);border-color:var(--green-b);background:var(--green-d)}
.pill-mode{color:var(--gold);border-color:rgba(251,191,36,.2);background:var(--gold-d)}
.dot-live{width:6px;height:6px;border-radius:50%;background:var(--green);
  box-shadow:0 0 8px var(--green);animation:pulse 2s infinite}
.sess-id{font-size:9px;color:var(--t4);font-family:var(--mono)}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.7)}}

/* ═══ LAYOUT ═════════════════════════════════ */
.app{display:flex;height:calc(100vh - 52px);position:relative;z-index:1}
.sidebar{width:280px;background:var(--bg1);border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;transition:margin-left .3s}
.sidebar.collapsed{margin-left:-280px}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.drawer{width:320px;background:var(--bg1);border-left:1px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;transition:margin-right .3s}
.drawer.collapsed{margin-right:-320px}

/* ═══ SIDEBAR ════════════════════════════════ */
.sb-section{padding:14px 16px;border-bottom:1px solid var(--border)}
.sb-label{font-size:9px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;
  color:var(--t3);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.sb-label::after{content:"";flex:1;height:1px;background:var(--border)}
.case-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.case-btn{padding:10px 6px;border-radius:var(--rs);background:var(--bg2);
  border:1.5px solid var(--border);cursor:pointer;text-align:center;transition:all .2s;
  display:flex;flex-direction:column;align-items:center;gap:3px}
.case-btn:hover{border-color:var(--border2);background:var(--bg3);transform:translateY(-1px)}
.case-btn.active{border-color:var(--accent);background:rgba(110,168,254,.06);
  box-shadow:0 0 12px rgba(110,168,254,.08)}
.case-btn .icon{font-size:20px}.case-btn .name{font-size:9px;font-weight:600;color:var(--t1)}
.case-btn.active.emp{border-color:var(--accent2);background:rgba(139,92,246,.06)}
.case-btn.active.con{border-color:var(--gold);background:var(--gold-d)}
.case-btn.active.crim{border-color:var(--red);background:var(--red-d)}
textarea,input[type=text],input#caseId,input#instrTxt{width:100%;background:var(--bg2);
  border:1px solid var(--border);border-radius:var(--rs);padding:8px 12px;color:var(--t1);
  font-family:var(--font);font-size:12px;outline:none;transition:all .2s;resize:none}
textarea:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(110,168,254,.08)}
textarea{height:80px;line-height:1.5}
.fg{display:flex;flex-direction:column;gap:6px}
.btn{padding:8px 14px;border-radius:var(--rs);border:none;font-family:var(--font);
  font-size:12px;font-weight:600;cursor:pointer;transition:all .25s;
  display:flex;align-items:center;justify-content:center;gap:6px;white-space:nowrap}
.btn-hero{width:100%;background:var(--accent-g);color:#0a0e1a;padding:10px;
  box-shadow:0 4px 16px rgba(110,168,254,.2);font-weight:700;border-radius:var(--r)}
.btn-hero:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(110,168,254,.3)}
.btn-act{background:linear-gradient(135deg,#1e40af,#6d28d9);color:#fff}
.btn-act:hover{transform:translateY(-1px)}
.btn:disabled{opacity:.3;cursor:not-allowed;transform:none!important}

/* Quick Scenarios */
.qa-scroll{flex:1;overflow-y:auto;padding:8px 12px;display:flex;flex-direction:column;gap:4px}
.qa-card{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:var(--rs);
  background:var(--bg2);border:1px solid var(--border);cursor:pointer;transition:all .2s}
.qa-card:hover{border-color:var(--border2);background:var(--bg3)}
.qa-icon{font-size:14px;flex-shrink:0}
.qa-body{flex:1;min-width:0}
.qa-title{font-size:11px;font-weight:600;color:var(--t1)}
.qa-desc{font-size:10px;color:var(--t3);margin-top:1px;line-height:1.3}
.qa-tag{display:inline-block;font-size:8px;font-weight:800;padding:1px 6px;border-radius:3px;margin-top:2px}
.qa-ok{background:var(--green-d);color:var(--green)}
.qa-no{background:var(--red-d);color:var(--red)}

/* ═══ MAIN CENTER ════════════════════════════ */
.tabs{display:flex;border-bottom:1px solid var(--border);background:var(--bg1);flex-shrink:0}
.tab{padding:10px 18px;font-size:12px;font-weight:600;color:var(--t3);cursor:pointer;
  border-bottom:2px solid transparent;transition:all .2s;display:flex;align-items:center;
  gap:6px;user-select:none;white-space:nowrap}
.tab:hover{color:var(--t1);background:var(--surface)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab-badge{font-size:9px;padding:1px 6px;border-radius:10px;
  background:rgba(110,168,254,.08);color:var(--accent);border:1px solid rgba(110,168,254,.15)}
.tab-panel{display:none;flex:1;flex-direction:column;overflow:hidden}
.tab-panel.show{display:flex}
.tab-left{margin-right:auto;display:flex;gap:0}.tab-right{display:flex;align-items:center;gap:8px;padding-right:12px}
.toggle-btn{background:none;border:1px solid var(--border);border-radius:6px;padding:4px 8px;
  font-size:11px;color:var(--t3);cursor:pointer;font-family:var(--font);transition:all .2s}
.toggle-btn:hover{color:var(--t1);border-color:var(--border2);background:var(--surface)}
.toggle-btn.active{color:var(--accent);border-color:rgba(110,168,254,.3);background:rgba(110,168,254,.06)}

/* ═══ CHAT AREA ══════════════════════════════ */
.chat-area{flex:1;overflow-y:auto;padding:20px 24px;display:flex;flex-direction:column;gap:12px}

/* Welcome */
.welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;
  flex:1;text-align:center;padding:40px 20px}
.w-icon{font-size:56px;margin-bottom:16px;animation:float 3s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.w-title{font-size:22px;font-weight:900;letter-spacing:-.02em;margin-bottom:6px;
  background:var(--accent-g);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.w-sub{font-size:13px;color:var(--t2);line-height:1.7;max-width:420px}
.w-actions{margin-top:20px;display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
.w-chip{padding:6px 16px;border-radius:20px;font-size:11px;font-weight:600;cursor:pointer;
  border:1px solid var(--border2);color:var(--t2);background:transparent;font-family:var(--font);
  transition:all .2s}
.w-chip:hover{background:var(--bg3);color:var(--t1)}
.w-chip.primary{border-color:var(--accent);color:var(--accent)}
.w-chip.primary:hover{background:rgba(110,168,254,.08)}

/* Thinking */
.thinking{display:flex;align-items:center;gap:8px;padding:10px 14px;
  background:rgba(110,168,254,.03);border:1px solid rgba(110,168,254,.1);border-radius:var(--r);
  font-size:12px;color:var(--t3);animation:fadeIn .25s}
.dots{display:flex;gap:3px}
.dots span{width:5px;height:5px;border-radius:50%;background:var(--accent);animation:bounce 1s ease-in-out infinite}
.dots span:nth-child(2){animation-delay:.15s}
.dots span:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,80%,100%{transform:translateY(0);opacity:.3}40%{transform:translateY(-5px);opacity:1}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* Scene divider */
.scene-div{display:flex;align-items:center;gap:10px;margin:4px 0}
.scene-line{flex:1;height:1px;background:var(--border)}
.scene-pill{font-size:9px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;
  padding:3px 12px;border-radius:20px;border:1px solid;white-space:nowrap}
.scene-ok{color:var(--accent);border-color:rgba(110,168,254,.25);background:rgba(110,168,254,.06)}
.scene-no{color:var(--red);border-color:var(--red-b);background:var(--red-d)}
.scene-del{color:var(--accent2);border-color:rgba(139,92,246,.25);background:rgba(139,92,246,.06)}

/* Messages */
.msg{display:flex;gap:10px;animation:slideUp .3s ease-out;max-width:100%}
.msg.from-agent{align-self:flex-start}
.msg.from-client{align-self:flex-end;flex-direction:row-reverse}
.msg.from-sys{align-self:center}
.msg-av{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;
  justify-content:center;font-size:14px;flex-shrink:0;margin-top:2px}
.av-agent{background:var(--accent-g)}
.av-client{background:linear-gradient(135deg,var(--gold),#f59e0b)}
.msg-body{max-width:520px;display:flex;flex-direction:column;gap:2px}
.msg-name{font-size:9px;font-weight:700;letter-spacing:.05em;color:var(--t4);margin-bottom:1px}
.msg.from-client .msg-name{text-align:right}
.bubble{padding:10px 14px;border-radius:14px;font-size:13px;line-height:1.65}

.bubble-agent{background:var(--bg2);border:1px solid var(--border);color:var(--t1);border-radius:14px 14px 14px 4px}
.bubble-agent.ok{border-color:var(--green-b);background:rgba(52,211,153,.03)}
.bubble-agent.no{border-color:var(--red-b);background:rgba(248,113,113,.03)}

.bubble-client{background:linear-gradient(135deg,rgba(251,191,36,.08),rgba(251,191,36,.03));
  border:1px solid rgba(251,191,36,.15);color:var(--t1);border-radius:14px 14px 4px 14px}

.bubble-sys{background:var(--bg3);border:1px solid var(--border);color:var(--t2);
  border-radius:8px;font-size:11px;padding:6px 12px}

/* Enrichment inside agent bubbles */
.msg-advice{margin-top:8px;font-size:12px;color:var(--t2);line-height:1.55;
  border-top:1px solid rgba(255,255,255,.06);padding-top:8px}
.msg-toggle{margin-top:8px;font-size:11px;color:var(--accent);cursor:pointer;user-select:none;
  opacity:.8;transition:opacity .2s}
.msg-toggle:hover{opacity:1}
.msg-detail{display:none;margin-top:6px;padding:10px 12px;background:rgba(0,0,0,.3);
  border-left:2px solid var(--accent);border-radius:0 6px 6px 0;font-size:11px;
  font-family:var(--mono);color:var(--t2);white-space:pre-wrap;max-height:260px;
  overflow-y:auto;line-height:1.6}
.msg-detail.open{display:block}
.msg-next{margin-top:8px;font-size:11px;color:var(--green);opacity:.85}
.msg-blocked-reason{margin-top:8px;font-size:11px;color:var(--red);opacity:.9}
.msg-tag{font-size:9px;font-family:var(--mono);font-weight:600;margin-top:6px;
  padding:2px 8px;border-radius:4px;display:inline-block}
.msg-tag.ok{background:var(--green-d);color:var(--green)}
.msg-tag.no{background:var(--red-d);color:var(--red)}

/* ═══ FEED CARDS ═════════════════════════════ */
.feed-area{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:8px}

.intake-card{background:rgba(52,211,153,.03);border:1px solid var(--green-b);
  border-radius:var(--r);padding:12px 14px;position:relative;animation:slideUp .35s;
  border-left:3px solid var(--green)}
.intake-label{font-size:9px;font-weight:700;letter-spacing:.1em;color:var(--green);margin-bottom:4px}

.client-card{background:var(--gold-d);border:1px solid rgba(251,191,36,.15);
  border-radius:var(--r);padding:12px 14px;border-left:3px solid var(--gold);animation:slideUp .35s}
.client-label{font-size:9px;font-weight:700;letter-spacing:.1em;color:var(--gold);margin-bottom:4px}
.client-text{font-size:12px;color:var(--t1);line-height:1.6;font-style:italic}

.decision-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);
  overflow:hidden;animation:slideUp .35s}
.dc-header{padding:8px 12px;background:var(--surface);border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:8px}
.dc-icon{width:26px;height:26px;border-radius:7px;display:flex;align-items:center;
  justify-content:center;font-size:12px;background:var(--bg3);flex-shrink:0}
.dc-action{font-family:var(--mono);font-size:11px;color:var(--accent);font-weight:500}
.dc-label-text{font-size:11px;color:var(--t2)}
.dc-del{font-size:9px;padding:1px 6px;border-radius:3px;background:rgba(139,92,246,.1);
  color:var(--accent2);border:1px solid rgba(139,92,246,.15);font-weight:600}
.dc-agent{margin-left:auto;font-size:10px;color:var(--t4)}
.dc-body{padding:10px 12px;display:flex;flex-direction:column;gap:5px}
.dc-row{display:flex;gap:8px;font-size:11px}
.dc-key{color:var(--t4);width:55px;flex-shrink:0;font-weight:500}
.dc-val{color:var(--t2);flex:1;line-height:1.5}
.verdict{margin-top:6px;border-radius:8px;padding:8px 12px;display:flex;flex-direction:column;gap:4px}
.verdict.ok{background:var(--green-d);border:1px solid var(--green-b)}
.verdict.no{background:var(--red-d);border:1px solid var(--red-b)}
.verdict-top{display:flex;align-items:center;gap:8px}
.verdict-badge{font-size:9px;font-weight:800;letter-spacing:.06em;padding:2px 8px;border-radius:5px}
.verdict-badge.ok{background:rgba(52,211,153,.15);color:var(--green)}
.verdict-badge.no{background:rgba(248,113,113,.15);color:var(--red)}
.verdict-reason{font-size:11px;color:var(--t2);line-height:1.5}
.verdict-rule{font-size:10px;font-family:var(--mono);color:var(--red);padding:4px 8px;
  background:rgba(248,113,113,.05);border-radius:4px;border-left:2px solid var(--red);margin-top:3px}
.armoriq-sig{margin-top:6px;font-size:10px;font-family:var(--mono);color:var(--green);opacity:.8}

/* Summary card */
.summary-card{border-radius:var(--r);overflow:hidden;animation:slideUp .5s;border:1px solid rgba(110,168,254,.2)}
.summary-header{padding:16px 18px;background:linear-gradient(135deg,rgba(110,168,254,.08),rgba(139,92,246,.06));
  border-bottom:1px solid rgba(110,168,254,.1);display:flex;align-items:center;gap:14px}
.summary-icon{font-size:30px}
.summary-title{font-size:15px;font-weight:800;background:var(--accent-g);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.summary-sub{font-size:11px;color:var(--t3);margin-top:2px}
.summary-body{padding:16px 18px;background:var(--bg2)}
.summary-stats{display:flex;gap:10px;margin-bottom:16px}
.summary-stat{flex:1;padding:10px;border-radius:8px;text-align:center}
.summary-stat.ok{background:var(--green-d);border:1px solid var(--green-b)}
.summary-stat.no{background:var(--red-d);border:1px solid var(--red-b)}
.summary-stat-n{font-size:22px;font-weight:800}
.summary-stat.ok .summary-stat-n{color:var(--green)}
.summary-stat.no .summary-stat-n{color:var(--red)}
.summary-stat-l{font-size:9px;color:var(--t3);margin-top:2px}
.summary-label{font-size:10px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;
  color:var(--t3);margin-bottom:8px}
.finding{display:flex;align-items:flex-start;gap:8px;padding:7px 10px;background:var(--green-d);
  border:1px solid rgba(52,211,153,.12);border-radius:6px;font-size:12px;color:var(--t1);
  line-height:1.5;margin-bottom:4px}
.step-item{display:flex;align-items:flex-start;gap:10px;padding:8px 12px;background:var(--bg3);
  border:1px solid var(--border);border-radius:8px;margin-bottom:5px}
.step-num{width:20px;height:20px;border-radius:50%;background:var(--accent-g);color:#0a0e1a;
  font-size:10px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.step-text{font-size:12px;color:var(--t1);line-height:1.5}

/* ═══ AUDIT TABLE ════════════════════════════ */
.audit-area{flex:1;display:flex;flex-direction:column;overflow:hidden}
.audit-toolbar{padding:10px 16px;border-bottom:1px solid var(--border);flex-shrink:0;
  display:flex;align-items:center;gap:8px}
.filter-btn{padding:4px 12px;border-radius:14px;font-size:11px;font-weight:600;
  border:1px solid var(--border);background:transparent;color:var(--t3);cursor:pointer;
  font-family:var(--font);transition:all .2s}
.filter-btn:hover{background:var(--bg3);color:var(--t1)}
.filter-btn.active{background:rgba(110,168,254,.06);color:var(--accent);border-color:rgba(110,168,254,.25)}
.export-btn{margin-left:auto;padding:4px 12px;border-radius:14px;font-size:11px;font-weight:600;
  border:1px solid var(--border2);background:transparent;color:var(--t2);cursor:pointer;font-family:var(--font);
  transition:all .2s}
.export-btn:hover{background:var(--bg3);color:var(--t1)}
.audit-scroll{flex:1;overflow-y:auto;padding:8px}
.audit-empty{padding:40px;text-align:center;color:var(--t3);font-size:12px}
.audit-table{width:100%;border-collapse:collapse}
.audit-table th{font-size:9px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;
  color:var(--t3);padding:6px 10px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap}
.audit-table td{padding:7px 10px;border-bottom:1px solid rgba(110,168,254,.04);font-size:11px;vertical-align:top}
.audit-table tr:hover td{background:var(--bg2)}
.a-time{font-family:var(--mono);font-size:10px;color:var(--t4)}
.a-agent{color:var(--accent);font-weight:500}
.a-del{font-size:9px;color:var(--accent2)}
.a-act-code{font-family:var(--mono);font-size:9px;color:var(--t4)}
.a-label{font-size:11px;color:var(--t1)}
.a-badge{font-size:9px;font-weight:700;padding:2px 7px;border-radius:4px}
.a-badge.ok{background:rgba(52,211,153,.12);color:var(--green)}
.a-badge.no{background:rgba(248,113,113,.12);color:var(--red)}
.a-rule{font-size:9px;font-family:var(--mono);color:var(--red);max-width:150px;overflow:hidden;
  text-overflow:ellipsis;white-space:nowrap}
.a-plain{font-size:10px;color:var(--t3);max-width:200px;line-height:1.4}
.hidden-row{display:none!important}

/* ═══ DRAWER (RIGHT) ═════════════════════════ */
.drawer-hdr{padding:11px 14px;border-bottom:1px solid var(--border);flex-shrink:0;
  display:flex;align-items:center;justify-content:space-between}
.drawer-title{font-size:12px;font-weight:700;display:flex;align-items:center;gap:6px}
.drawer-count{font-size:9px;padding:2px 8px;border-radius:12px;
  background:rgba(110,168,254,.06);color:var(--accent);border:1px solid rgba(110,168,254,.15)}
.mini-log{flex:1;overflow-y:auto;padding:6px}
.log-entry{padding:6px 8px;border-radius:6px;background:var(--bg2);border:1px solid var(--border);
  border-left:3px solid;margin-bottom:3px;font-size:10px;animation:slideUp .3s}
.log-entry.ok{border-left-color:var(--green)}
.log-entry.no{border-left-color:var(--red)}
.log-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:2px}
.log-action{font-family:var(--mono);color:var(--t1);font-weight:500}
.log-badge{font-size:9px;font-weight:700;padding:1px 6px;border-radius:3px}
.log-badge.ok{background:rgba(52,211,153,.12);color:var(--green)}
.log-badge.no{background:rgba(248,113,113,.12);color:var(--red)}
.log-agent{color:var(--t4)}.log-rule{color:var(--red);font-family:var(--mono);font-size:9px;margin-top:1px;opacity:.85}
.merkle-section{border-top:1px solid var(--border);padding:10px;flex:1;overflow-y:auto;
  display:flex;flex-direction:column;gap:5px}
.merkle-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.tamper-btn{font-size:9px;padding:3px 9px;border-radius:5px;border:1px solid var(--border);
  background:var(--bg3);color:var(--t2);cursor:pointer;font-family:var(--font);transition:all .2s}
.tamper-btn:hover{background:rgba(110,168,254,.06);color:var(--accent);border-color:var(--accent)}
.m-node{display:flex;flex-direction:column;padding:6px 8px;border-left:2px solid var(--accent);
  background:rgba(110,168,254,.03);border-radius:0 6px 6px 0;margin-left:8px;position:relative}
.m-node::before{content:"";position:absolute;left:-10px;top:10px;width:8px;height:2px;background:var(--accent)}
.m-node.blocked{border-left-color:var(--red);background:var(--red-d)}
.m-node.blocked::before{background:var(--red)}
.m-node.tampered{border-left-color:var(--red);background:rgba(248,113,113,.12);animation:shake .4s ease-in-out infinite}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-2px)}75%{transform:translateX(2px)}}
.m-hash{font-family:var(--mono);font-size:9px;color:var(--t4);display:flex;justify-content:space-between}
.m-act{font-size:10px;color:var(--t1);font-weight:600;margin-top:2px}

/* ═══ CHAT INPUT BAR ═════════════════════════ */
.input-bar{padding:10px 20px;border-top:1px solid var(--border);flex-shrink:0;background:var(--bg1);
  display:flex;gap:8px;align-items:center}
.mode-tag{font-size:9px;font-weight:700;padding:3px 10px;border-radius:6px;flex-shrink:0;
  letter-spacing:.03em;white-space:nowrap;transition:all .3s}
.mode-tag.qa{background:rgba(110,168,254,.06);color:var(--accent);border:1px solid rgba(110,168,254,.2)}
.mode-tag.case{background:var(--green-d);color:var(--green);border:1px solid var(--green-b)}
.chat-input{flex:1;height:38px;border-radius:19px;padding:0 16px;font-size:12px;
  border:1px solid var(--border);background:var(--bg2);color:var(--t1);outline:none;transition:all .2s}
.chat-input:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(110,168,254,.06)}
.send-btn{width:38px;height:38px;border-radius:50%;border:none;cursor:pointer;flex-shrink:0;
  background:var(--accent-g);display:flex;align-items:center;justify-content:center;
  font-size:15px;transition:all .2s;color:#0a0e1a;font-weight:800}
.send-btn:hover{transform:scale(1.05);box-shadow:0 4px 16px rgba(110,168,254,.25)}

/* Progress */
.progress{height:2px;background:var(--border);flex-shrink:0;overflow:hidden}
.progress-fill{height:100%;background:var(--accent-g);width:0%;transition:width .5s ease}

/* ═══ RESPONSIVE ═════════════════════════════ */
@media(max-width:1100px){.drawer{width:260px}}
@media(max-width:900px){.sidebar{position:fixed;left:0;top:52px;bottom:0;z-index:30;box-shadow:var(--shadow-lg)}
  .drawer{position:fixed;right:0;top:52px;bottom:0;z-index:30;box-shadow:var(--shadow-lg)}}
</style>
</head>
<body>

<!-- ═══ HEADER ═════════════════════════════════ -->
<header class="hdr">
  <div class="hdr-left">
    <div class="hdr-logo">⚖️</div>
    <div>
      <div class="hdr-name">CLAW</div>
      <div class="hdr-sub">AI Legal Assistant · ArmorIQ Intent Enforcement</div>
    </div>
  </div>
  <div class="hdr-right">
    <span class="hdr-pill pill-bns">BNS 2023</span>
    <span class="hdr-pill pill-mode">Simulation</span>
    <div class="hdr-stat h-green"><div class="hdr-stat-n" id="hAllowed">0</div><div class="hdr-stat-l">Allowed</div></div>
    <div class="hdr-stat h-red"><div class="hdr-stat-n" id="hBlocked">0</div><div class="hdr-stat-l">Blocked</div></div>
    <div class="hdr-stat h-blue"><div class="hdr-stat-n" id="hTotal">0</div><div class="hdr-stat-l">Total</div></div>
    <div class="dot-live"></div>
    <span class="sess-id" id="sessLabel">Session —</span>
  </div>
</header>

<!-- ═══ APP BODY ════════════════════════════════ -->
<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sb-section">
      <div class="sb-label">Case Type</div>
      <div class="case-grid">
        <div class="case-btn active" id="cc-lt" onclick="selectCase('lt')"><span class="icon">🏠</span><span class="name">Landlord</span></div>
        <div class="case-btn emp" id="cc-emp" onclick="selectCase('emp')"><span class="icon">💼</span><span class="name">Employment</span></div>
        <div class="case-btn con" id="cc-con" onclick="selectCase('con')"><span class="icon">📋</span><span class="name">Contract</span></div>
        <div class="case-btn crim" id="cc-crim" onclick="selectCase('crim')"><span class="icon">⚖️</span><span class="name">Criminal</span></div>
      </div>
    </div>
    <div class="sb-section">
      <div class="sb-label">Client Statement</div>
      <div class="fg">
        <textarea id="stmtTxt" placeholder="Describe the client's situation in detail…"></textarea>
        <input id="caseId" value="CASE-2026-001" placeholder="Case ID"/>
        <button class="btn btn-hero" id="demoBtn" onclick="runDemo()">▶ Run Full Demo</button>
      </div>
    </div>
    <div class="sb-section">
      <div class="sb-label">Execute Action</div>
      <div class="fg">
        <input id="instrTxt" placeholder="e.g. landlord illegal entry…"/>
        <button class="btn btn-act" id="actBtn" onclick="runAct()">⚡ Execute</button>
      </div>
    </div>
    <div class="sb-label" style="padding:10px 16px 0;flex-shrink:0">Quick Scenarios</div>
    <div class="qa-scroll">
      <div class="qa-card" onclick="setQA('landlord apartment illegal entry','My landlord is illegally entering my apartment without notice.')">
        <span class="qa-icon">🏠</span>
        <div class="qa-body"><div class="qa-title">Landlord illegal entry</div><div class="qa-desc">Tenant rights, legal notice, BNS S.329</div><span class="qa-tag qa-ok">ALLOWED</span></div>
      </div>
      <div class="qa-card" onclick="setQA('wrongful termination unpaid wages employment dispute','My employer fired me without cause and owes 3 months salary.')">
        <span class="qa-icon">💼</span>
        <div class="qa-body"><div class="qa-title">Wrongful termination</div><div class="qa-desc">Labour law, damages, demand notice</div><span class="qa-tag qa-ok">ALLOWED</span></div>
      </div>
      <div class="qa-card" onclick="setQA('breach of contract software vendor defective delivery','Vendor delivered defective software, refusing to compensate.')">
        <span class="qa-icon">📋</span>
        <div class="qa-body"><div class="qa-title">Contract breach</div><div class="qa-desc">ICA 1872, arbitration, damages</div><span class="qa-tag qa-ok">ALLOWED</span></div>
      </div>
      <div class="qa-card" onclick="setQA('bail application wrongful arrest financial fraud defence strategy','My client was wrongly arrested for financial fraud.')">
        <span class="qa-icon">⚖️</span>
        <div class="qa-body"><div class="qa-title">Criminal defence</div><div class="qa-desc">Bail under BNSS S.480, defence strategy</div><span class="qa-tag qa-ok">ALLOWED</span></div>
      </div>
      <div class="qa-card" onclick="setQA(&quot;tell them we never received that notice, say we didn't get it&quot;,'')">
        <span class="qa-icon">🚫</span>
        <div class="qa-body"><div class="qa-title">Perjury attempt</div><div class="qa-desc">Coach client to lie — BNS S.227</div><span class="qa-tag qa-no">BLOCKED</span></div>
      </div>
      <div class="qa-card" onclick="setQA('contact them directly, message opposing party landlord','')">
        <span class="qa-icon">🚫</span>
        <div class="qa-body"><div class="qa-title">Direct contact</div><div class="qa-desc">Contact opposing party — Rule 4.2</div><span class="qa-tag qa-no">BLOCKED</span></div>
      </div>
      <div class="qa-card" onclick="setQA('destroy the performance improvement plan documents so they cannot use them','')">
        <span class="qa-icon">🚫</span>
        <div class="qa-body"><div class="qa-title">Evidence destruction</div><div class="qa-desc">Delete case documents — BNS S.238</div><span class="qa-tag qa-no">BLOCKED</span></div>
      </div>
      <div class="qa-card" onclick="setQA('advise the client to bribe the investigating officer','')">
        <span class="qa-icon">🚫</span>
        <div class="qa-body"><div class="qa-title">Bribery</div><div class="qa-desc">Bribe official — PCA + BNS S.61</div><span class="qa-tag qa-no">BLOCKED</span></div>
      </div>
    </div>
  </aside>

  <!-- MAIN CENTER -->
  <main class="main">
    <div class="tabs">
      <div class="tab-left">
        <div class="tab active" id="tab-chat" onclick="switchTab('chat')">💬 Chat <span class="tab-badge" id="tb-chat">0</span></div>
        <div class="tab" id="tab-feed" onclick="switchTab('feed')">🤖 Agent Feed <span class="tab-badge" id="tb-feed">0</span></div>
        <div class="tab" id="tab-audit" onclick="switchTab('audit')">📋 Audit <span class="tab-badge" id="tb-audit">0</span></div>
      </div>
      <div class="tab-right">
        <button class="toggle-btn" id="toggleSidebar" onclick="togglePanel('sidebar')">◀ Panel</button>
        <button class="toggle-btn" id="toggleDrawer" onclick="togglePanel('drawer')">Logs ▶</button>
      </div>
    </div>

    <!-- CHAT TAB (primary) -->
    <div class="tab-panel show" id="panel-chat">
      <div class="chat-area" id="chatArea">
        <div class="welcome" id="welcomeMsg">
          <div class="w-icon">⚖️</div>
          <div class="w-title">CLAW — AI Legal Assistant</div>
          <div class="w-sub">Ask any legal question about Indian law, or register a case for full legal support. Every agent action is validated by the ArmorIQ policy engine. BNS 2023 enforced throughout.</div>
          <div class="w-actions">
            <button class="w-chip primary" onclick="runDemo()">▶ Run Full Demo</button>
            <button class="w-chip" onclick="setQA('What are my rights under Article 21?','')">🏛️ Constitution</button>
            <button class="w-chip" onclick="setQA('landlord apartment illegal entry','My landlord enters without notice')">🏠 Landlord</button>
            <button class="w-chip" onclick="setQA('wrongful termination unpaid wages','Fired without cause')">💼 Employment</button>
            <button class="w-chip" onclick="setQA('bail application wrongful arrest','Client arrested for fraud')">⚖️ Criminal</button>
          </div>
        </div>
      </div>
      <div class="input-bar">
        <span class="mode-tag qa" id="modeTag">💬 General Q&A</span>
        <input class="chat-input" id="chatIn" placeholder="Ask any legal question — or register a case for full support…" onkeydown="if(event.key==='Enter')runAct()"/>
        <button class="send-btn" onclick="runAct()">➤</button>
      </div>
    </div>

    <!-- AGENT FEED TAB -->
    <div class="tab-panel" id="panel-feed">
      <div style="padding:12px 20px;border-bottom:1px solid var(--border);flex-shrink:0">
        <div style="font-size:14px;font-weight:700">Agent Decision Feed</div>
        <div style="font-size:10px;color:var(--t3);margin-top:1px">Real-time intent validation — every action checked before execution</div>
      </div>
      <div class="progress"><div class="progress-fill" id="progFill"></div></div>
      <div class="feed-area" id="feedArea">
        <div style="text-align:center;padding:40px 20px;color:var(--t3);font-size:12px">Run the demo or execute an action to see agent decisions here.</div>
      </div>
    </div>

    <!-- AUDIT TAB -->
    <div class="tab-panel" id="panel-audit">
      <div class="audit-area">
        <div class="audit-toolbar">
          <button class="filter-btn active" id="f-all" onclick="filterAudit('all')">All</button>
          <button class="filter-btn" id="f-ok" onclick="filterAudit('ok')">✅ Allowed</button>
          <button class="filter-btn" id="f-no" onclick="filterAudit('no')">🚫 Blocked</button>
          <button class="export-btn" onclick="exportAudit()">⬇ Export JSON</button>
        </div>
        <div class="audit-scroll">
          <div class="audit-empty" id="auditEmpty">No decisions logged yet. Run the demo to populate.</div>
          <table class="audit-table" id="auditTable" style="display:none">
            <thead><tr><th>Time</th><th>Agent</th><th>Action</th><th>Status</th><th>Rule / BNS</th><th>Plain English</th></tr></thead>
            <tbody id="auditBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- RIGHT DRAWER -->
  <aside class="drawer" id="drawer">
    <div class="drawer-hdr">
      <div class="drawer-title">📝 Live Decisions</div>
      <div class="drawer-count" id="logCount">0</div>
    </div>
    <div class="mini-log" id="miniLog">
      <div style="padding:20px 10px;text-align:center;color:var(--t4);font-size:11px">Decisions appear here as the agent acts.</div>
    </div>
    <div class="merkle-section">
      <div class="merkle-header">
        <div class="sb-label" style="margin:0">Intent Chain (CSRG)</div>
        <button class="tamper-btn" onclick="testTamper()">Tamper Test</button>
      </div>
      <div id="merkleList" style="font-size:10px;color:var(--t4);text-align:center;padding:10px">No intents logged yet.</div>
    </div>
  </aside>
</div>

<script>
const API='';
let allowed=0,blocked=0,total=0,auditFilter='all',_caseReady=false;

/* ─── Helpers ─── */
const CASES={
  lt:{stmt:"My landlord is illegally entering my apartment without notice and threatening to evict me without cause.",instr:"landlord apartment illegal entry"},
  emp:{stmt:"My employer fired me without cause after I raised concerns about wage theft. I haven't received 3 months salary.",instr:"wrongful termination unpaid wages employment dispute"},
  con:{stmt:"A vendor delivered defective software causing significant losses. They refuse to compensate despite breach of contract.",instr:"breach of contract software vendor defective delivery"},
  crim:{stmt:"My client has been wrongly accused of financial fraud and arrested yesterday. Need urgent bail application.",instr:"bail application wrongful arrest financial fraud defence strategy"}
};

function $(id){return document.getElementById(id)}
function updateModeTag(){
  const tag=$('modeTag');if(!tag)return;
  if(_caseReady){tag.textContent='⚖️ Case Mode';tag.className='mode-tag case';
    $('chatIn').placeholder='Type an instruction for your case…'}
  else{tag.textContent='💬 General Q&A';tag.className='mode-tag qa';
    $('chatIn').placeholder='Ask any legal question — or register a case for full support…'}
}
function switchTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('show'));
  $('tab-'+name).classList.add('active');$('panel-'+name).classList.add('show');
}
function togglePanel(id){
  const el=$(id);el.classList.toggle('collapsed');
  const btn=$(id==='sidebar'?'toggleSidebar':'toggleDrawer');
  if(id==='sidebar')btn.textContent=el.classList.contains('collapsed')?'▶ Panel':'◀ Panel';
  else btn.textContent=el.classList.contains('collapsed')?'Logs ▶':'Logs ◀';
}
function selectCase(k){
  document.querySelectorAll('.case-btn').forEach(c=>c.classList.remove('active'));
  $('cc-'+k).classList.add('active');
  const c=CASES[k];if(c){$('stmtTxt').value=c.stmt;$('instrTxt').value=c.instr;$('chatIn').value=c.instr}
}
function setQA(instr,stmt){
  if(stmt)$('stmtTxt').value=stmt;$('instrTxt').value=instr;$('chatIn').value=instr;
}
function updateStats(a,b,t){
  $('hAllowed').textContent=a;$('hBlocked').textContent=b;$('hTotal').textContent=t;
  $('tb-chat').textContent=t;$('tb-feed').textContent=t;$('tb-audit').textContent=t;$('logCount').textContent=t;
}
function showThinking(txt){
  const area=$('chatArea');
  let el=$('thinkIndicator');
  if(!el){el=document.createElement('div');el.id='thinkIndicator';el.className='thinking';area.appendChild(el)}
  el.innerHTML='<div class="dots"><span></span><span></span><span></span></div><span>'+(txt||'Processing…')+'</span>';
  area.scrollTop=area.scrollHeight;
}
function hideThinking(){const el=$('thinkIndicator');if(el)el.remove()}
function setProgress(p){$('progFill').style.width=p+'%'}
function hideWelcome(){const w=$('welcomeMsg');if(w)w.style.display='none'}

/* ─── Feed helpers ─── */
function addToFeed(html){
  const f=$('feedArea');const ph=f.querySelector('div[style*=text-align]');if(ph)ph.remove();
  const d=document.createElement('div');d.innerHTML=html;f.appendChild(d.firstChild||d);f.scrollTop=f.scrollHeight;
}
function addScene(num,title){
  const cls=num<=2?'scene-ok':(num===5?'scene-del':'scene-no');
  addToFeed('<div class="scene-div"><div class="scene-line"></div><div class="scene-pill '+cls+'">Scene '+num+' — '+title+'</div><div class="scene-line"></div></div>');
}
function addThinkCard(txt){
  const id='tc'+Date.now();
  addToFeed('<div class="thinking" id="'+id+'"><div class="dots"><span></span><span></span><span></span></div><span>'+txt+'</span></div>');
  return id;
}
function addDecisionCard(d){
  const ok=d.decision==='ALLOWED';
  const del=d.delegated_by?'<span class="dc-del">via '+d.delegated_by+'</span>':'';
  const rule=(!ok&&d.rule_violated)?'<div class="verdict-rule">📌 '+d.rule_violated+'</div>':'';
  const res=(ok&&d.readable_result)?'<div class="dc-row"><div class="dc-key">Result</div><div class="dc-val">'+d.readable_result+'</div></div>':'';
  addToFeed('<div class="decision-card"><div class="dc-header"><div class="dc-icon">'+(ok?'✅':'🚫')+'</div><div><div class="dc-action">'+d.action+'</div><div class="dc-label-text">'+(d.action_label||'')+'</div></div>'+del+'<div class="dc-agent">'+d.agent+'</div></div><div class="dc-body"><div class="dc-row"><div class="dc-key">Target</div><div class="dc-val">'+(d.target||'—')+'</div></div><div class="dc-row"><div class="dc-key">Intent</div><div class="dc-val">'+(d.content||'').substring(0,100)+((d.content||'').length>100?'…':'')+'</div></div>'+res+'<div class="verdict '+(ok?'ok':'no')+'"><div class="verdict-top"><span class="verdict-badge '+(ok?'ok':'no')+'">'+(d.enforcement_type||d.decision)+'</span><span class="verdict-reason">'+(d.reason||'').substring(0,140)+((d.reason||'').length>140?'…':'')+'</span></div>'+rule+(d.armoriq_enforced?'<div class="armoriq-sig">🔐 ArmorIQ CSRG verified · token '+(d.armoriq_token_id?(d.armoriq_token_id).substring(0,16)+'…':'')+' · hash '+(d.armoriq_plan_hash?(d.armoriq_plan_hash).substring(0,16)+'…':'')+'</div>':'')+'</div></div></div>');
}

/* ─── Chat messages ─── */
function addChatMsg(type,text,meta){
  hideWelcome();
  const area=$('chatArea');const ok=meta&&meta.ok;const isBlocked=meta&&meta.blocked;
  let html='';
  if(type==='agent'){
    const cls=isBlocked?'no':(ok?'ok':'');
    const tag=meta&&meta.action?'<div class="msg-tag '+(isBlocked?'no':'ok')+'">'+(isBlocked?'🚫 BLOCKED':'✅ '+meta.action_label)+'</div>':'';
    const badge=(meta&&meta.type_override==='injection_demo')?'<div class="msg-tag no">⚠️ INJECTION SEVERED</div>':tag;
    const adviceHtml=(ok&&meta.advice)?'<div class="msg-advice">'+meta.advice+'</div>':'';
    const uid='r'+Date.now()+Math.random().toString(36).slice(2,6);
    const detailHtml=(ok&&meta.detail)?'<div class="msg-toggle" onclick="toggleDetail(\''+uid+'\')">▶ View Full Output</div><div class="msg-detail" id="'+uid+'">'+meta.detail.replace(/\n/g,'<br/>')+'</div>':'';
    const nextHtml=(ok&&meta.next)?'<div class="msg-next">→ '+meta.next+'</div>':'';
    const blockHtml=(!ok&&meta.block_reason)?'<div class="msg-blocked-reason">'+meta.block_reason+'</div>':'';
    html='<div class="msg from-agent"><div class="msg-av av-agent">🤖</div><div class="msg-body"><div class="msg-name">LEGAL AGENT</div><div class="bubble bubble-agent '+cls+'">'+text+adviceHtml+detailHtml+nextHtml+blockHtml+badge+'</div></div></div>';
  }else if(type==='client'){
    html='<div class="msg from-client"><div class="msg-av av-client">👤</div><div class="msg-body"><div class="msg-name" style="text-align:right">YOU</div><div class="bubble bubble-client">'+text+'</div></div></div>';
  }else{
    html='<div class="msg from-sys"><div class="bubble bubble-sys">🔵 '+text+'</div></div>';
  }
  const wrap=document.createElement('div');wrap.innerHTML=html;area.appendChild(wrap.firstChild);
  area.scrollTop=area.scrollHeight;
}
function toggleDetail(id){
  const el=$(id);if(!el)return;const open=el.classList.toggle('open');
  const toggle=el.previousElementSibling;if(toggle)toggle.textContent=(open?'▼':'▶')+' View Full Output';
}

/* ─── Right panels ─── */
function addMiniLog(d){
  const ok=d.decision==='ALLOWED';const log=$('miniLog');
  const ph=log.querySelector('div[style]');if(ph)ph.remove();
  const e=document.createElement('div');e.className='log-entry '+(ok?'ok':'no');
  const rule=(!ok&&d.rule_violated)?'<div class="log-rule">'+d.rule_violated+'</div>':'';
  e.innerHTML='<div class="log-top"><span class="log-action">'+d.action+'</span><span class="log-badge '+(ok?'ok':'no')+'">'+d.decision+'</span></div><div class="log-agent">'+d.agent+(d.delegated_by?' (delegated)':'')+'</div>'+rule;
  log.insertBefore(e,log.firstChild);
}
function addAuditRow(d){
  const empty=$('auditEmpty');const table=$('auditTable');
  if(empty)empty.style.display='none';table.style.display='table';
  const ok=d.decision==='ALLOWED';
  const time=d.timestamp?d.timestamp.substring(11,16):new Date().toTimeString().substring(0,5);
  const del=d.delegated_by?'<br/><span class="a-del">via '+d.delegated_by+'</span>':'';
  const rule=d.rule_violated?'<div class="a-rule" title="'+d.rule_violated+'">'+d.rule_violated+'</div>':'<span style="color:var(--t4)">—</span>';
  const plain=d.plain_english||d.reason||'';
  const tr=document.createElement('tr');tr.dataset.status=ok?'ok':'no';
  tr.className=(auditFilter!=='all'&&tr.dataset.status!==auditFilter)?'hidden-row':'';
  tr.innerHTML='<td class="a-time">'+time+'</td><td><span class="a-agent">'+d.agent+'</span>'+del+'</td><td><div class="a-label">'+(d.action_label||d.action)+'</div><div class="a-act-code">'+d.action+'</div></td><td><span class="a-badge '+(ok?'ok':'no')+'">'+d.decision+'</span></td><td>'+rule+'</td><td><div class="a-plain" title="'+plain+'">'+plain.substring(0,110)+(plain.length>110?'…':'')+'</div></td>';
  $('auditBody').appendChild(tr);
}
function filterAudit(f){
  auditFilter=f;document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  $('f-'+f).classList.add('active');
  document.querySelectorAll('#auditBody tr').forEach(tr=>{
    if(f==='all')tr.classList.remove('hidden-row');
    else tr.classList.toggle('hidden-row',tr.dataset.status!==f);
  });
}
async function exportAudit(){
  const r=await fetch('/api/audit/export');const blob=await r.blob();
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='audit_log.json';a.click();
}
async function fetchMerkle(){
  try{
    const r=await fetch('/api/merkle');const data=await r.json();const l=$('merkleList');
    if(!data.nodes||!data.nodes.length){l.innerHTML='<div style="text-align:center;padding:10px">No intents logged.</div>';return}
    const tAt=data.integrity.valid?-1:data.integrity.tampered_at;
    l.innerHTML=data.nodes.map(function(n,i){
      const cls=(n.is_blocked?'blocked ':'')+((tAt!==-1&&i>=tAt)?'tampered':'');
      const icon=n.is_blocked?'🚫':'✅';const pH=i===0?'GENESIS':n.parent_hash;
      return '<div class="m-node '+cls+'"><div class="m-hash"><span>'+icon+' Node '+i+'</span><span>'+n.node_hash+'</span></div><div class="m-act">'+n.action+'</div><div class="m-hash" style="margin-top:3px;opacity:0.6">Parent: '+pH+'</div></div>';
    }).join('');
  }catch(e){}
}
async function testTamper(){try{await fetch('/api/merkle/tamper',{method:'POST'});fetchMerkle()}catch(e){}}

/* ─── Process Decision ─── */
function processDecision(d){
  total++;if(d.decision==='ALLOWED')allowed++;else blocked++;
  updateStats(allowed,blocked,total);
  addDecisionCard(d);addMiniLog(d);addAuditRow(d);fetchMerkle();
  const ok=d.decision==='ALLOWED';
  const plain=d.plain_english||(ok?'Your lawyer completed an action on your behalf.':'Your lawyer refused this request.');
  addChatMsg('agent',plain,{
    ok:ok,blocked:!ok,action:d.action,action_label:d.action_label||d.action,type_override:d.type_override,
    advice:ok?(d.client_advice||''):'',detail:ok?(d.readable_result||d.result||''):'',
    next:ok?(d.next_step||''):'',block_reason:!ok?(d.reason||''):'',
  });
}

/* ─── Run Act ─── */
async function runAct(){
  const chatInEl=$('chatIn');const instrTxtEl=$('instrTxt');
  const instr=(chatInEl.value||instrTxtEl.value||'').trim();if(!instr)return;
  hideWelcome();showThinking('Agent processing: '+instr.substring(0,40)+'…');
  addChatMsg('client','"'+instr+'"',{});
  const stmtTxt=($('stmtTxt').value||'').trim();const caseId=$('caseId').value||'CASE-2026-001';
  try{
    if(stmtTxt&&!_caseReady){
      await fetch('/api/intake',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({case_id:caseId,client_statement:stmtTxt})});
      _caseReady=true;updateModeTag();
      addChatMsg('system','Case registered: '+caseId+'. Your lawyer is now reviewing your situation.');
    }
    const endpoint=_caseReady?'/api/act':'/api/ask';
    const body=_caseReady?{case_id:caseId,instruction:instr}:{question:instr};
    const resp=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const data=await resp.json();hideThinking();
    (data.results||[]).forEach(function(d){processDecision(d)});
  }catch(e){hideThinking();addChatMsg('system','Server error. Is the backend running?',{})}
  chatInEl.value='';
}

/* ─── Run Demo (SSE) ─── */
async function runDemo(){
  hideWelcome();_caseReady=false;updateModeTag();
  allowed=0;blocked=0;total=0;updateStats(0,0,0);
  $('feedArea').innerHTML='';$('chatArea').innerHTML='';
  $('auditBody').innerHTML='';$('auditEmpty').style.display='block';$('auditTable').style.display='none';
  $('miniLog').innerHTML='<div style="padding:12px;text-align:center;color:var(--t4);font-size:11px">Starting demo…</div>';
  $('merkleList').innerHTML='<div style="padding:10px;text-align:center">Chain reset.</div>';
  var demoBtn=$('demoBtn');demoBtn.disabled=true;setProgress(0);
  var TOTAL_SCENES=7,scene=0;
  var es=new EventSource('/api/demo/stream');
  es.onmessage=function(e){
    var d=JSON.parse(e.data);
    if(d.session_id)$('sessLabel').textContent='Session '+d.session_id;
    if(d.type==='scene'){scene++;setProgress((scene/TOTAL_SCENES)*90);addScene(d.scene,d.title);
      addChatMsg('system','Scene '+d.scene+': '+d.title)}
    else if(d.type==='intake'){_caseReady=true;updateModeTag();
      addToFeed('<div class="intake-card"><div class="intake-label">✅ CASE REGISTERED</div><div style="font-size:12px;color:var(--t1)">'+d.statement+'</div><div style="font-size:10px;color:var(--t4);margin-top:4px">Case ID: '+d.case_id+'</div></div>');
      addChatMsg('system','Case registered: '+d.case_id+'. Your lawyer is reviewing your situation.');
      if(d.session_id)$('sessLabel').textContent='Session '+d.session_id}
    else if(d.type==='client_says'){
      addToFeed('<div class="client-card"><div class="client-label">👤 CLIENT SAYS</div><div class="client-text">'+d.text+'</div></div>');
      addChatMsg('client',d.text,{});if(d.plain_english)addChatMsg('system',d.plain_english)}
    else if(d.type==='thinking'){showThinking(d.text);addThinkCard(d.text)}
    else if(d.type==='decision'){hideThinking();processDecision(d)}
    else if(d.type==='summary'){
      setProgress(100);hideThinking();
      var findings=(d.findings||[]).map(function(f){return '<div class="finding"><span>✅</span>'+f+'</div>'}).join('');
      var steps=(d.next_steps||[]).map(function(s,i){return '<div class="step-item"><div class="step-num">'+(i+1)+'</div><div class="step-text">'+s+'</div></div>'}).join('');
      addToFeed('<div class="summary-card"><div class="summary-header"><div class="summary-icon">🏛️</div><div><div class="summary-title">Legal Action Plan Complete</div><div class="summary-sub">Session '+(d.session_id||'')+' · ArmorIQ × CLAW</div></div></div><div class="summary-body"><div class="summary-stats"><div class="summary-stat ok"><div class="summary-stat-n">'+d.allowed+'</div><div class="summary-stat-l">Actions Taken</div></div><div class="summary-stat no"><div class="summary-stat-n">'+d.blocked+'</div><div class="summary-stat-l">Blocked</div></div></div><div class="summary-label" style="display:flex;justify-content:space-between"><span>📌 Key Findings</span><span style="font-family:var(--mono)">'+d.reasoning_mode+'</span></div><div style="margin-bottom:14px">'+findings+'</div><div class="summary-label">📋 Your Next Steps</div>'+steps+'<div class="summary-label" style="margin-top:12px">🔒 Merkle Root</div><div style="font-family:var(--mono);font-size:10px;color:var(--t2);background:var(--bg3);padding:7px;border-radius:5px">'+(d.merkle_root||"none")+'</div></div></div>');
      addChatMsg('system','Demo complete! '+d.allowed+' actions taken, '+d.blocked+' blocked.');
      es.close();demoBtn.disabled=false}
  };
  es.onerror=function(){es.close();hideThinking();demoBtn.disabled=false;setProgress(0)};
}

window.onload=function(){fetchMerkle();selectCase('lt')};
</script>
</body>
</html>
